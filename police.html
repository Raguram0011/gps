<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üöì Police SOS Control Center</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
body, html {
  margin: 0;
  padding: 0;
  font-family: 'Poppins', sans-serif;
  background: #0d1117;
  color: #fff;
  height: 100%;
  display: flex;
  flex-direction: column;
}
header {
  background: linear-gradient(135deg, #1e3c72, #2a5298);
  color: #fff;
  padding: 20px;
  text-align: center;
  font-size: 26px;
  font-weight: bold;
  letter-spacing: 1px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.5);
  position: relative;
}
header button {
  position: absolute;
  right: 20px;
  top: 20px;
  background: #ff9800;
  border: none;
  padding: 8px 14px;
  border-radius: 6px;
  font-weight: bold;
  cursor: pointer;
}
.dashboard {
  display: flex;
  flex: 1;
  gap: 15px;
  padding: 15px;
}
.leftPanel {
  flex: 0.4;
  display: flex;
  flex-direction: column;
  gap: 15px;
}
#statusChart {
  background: rgba(255,255,255,0.05);
  border-radius: 12px;
  padding: 10px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.6);
}
#sosContainer {
  background: rgba(255,255,255,0.05);
  border-radius: 12px;
  padding: 15px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.6);
  overflow-y: auto;
  max-height: 65vh;
  position: relative;
}
#sosContainer h2 {
  margin: 0 0 15px 0;
  font-size: 20px;
  color: #ffcc00;
  display: flex;
  align-items: center;
  gap: 8px;
}
.sosItem {
  background: rgba(255,255,255,0.08);
  margin: 10px 0;
  padding: 12px;
  border-radius: 8px;
  transition: transform 0.2s;
}
.sosItem:hover {
  transform: scale(1.02);
  background: rgba(255,255,255,0.15);
}
.sosItem a {
  color: #4fc3f7;
  font-weight: bold;
  text-decoration: none;
}
.statusBtn {
  margin: 5px 3px;
  padding: 5px 8px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-size: 12px;
  font-weight: bold;
  color: white;
}
.pending { background: #d32f2f; }
.progress { background: #fbc02d; color: #000; }
.resolved { background: #388e3c; }
.deleteBtn {
  background: #555;
  border: none;
  padding: 6px 10px;
  border-radius: 6px;
  cursor: pointer;
  font-weight: bold;
  color: white;
  font-size: 12px;
  margin-top: 5px;
}
#map {
  flex: 0.6;
  border-radius: 12px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.6);
}
.leaflet-control-attribution { display: none !important; }
/* History Modal */
#historyModal {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.7);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 9999;
}
#historyContent {
  background: #1e1e1e;
  padding: 20px;
  border-radius: 12px;
  width: 700px;
  max-height: 80vh;
  overflow-y: auto;
  box-shadow: 0 4px 15px rgba(0,0,0,0.6);
  position: relative;
}
.closeBtn {
  background: red;
  border: none;
  color: white;
  padding: 6px 12px;
  border-radius: 6px;
  cursor: pointer;
  font-weight: bold;
}
.downloadBtn {
  background: #4caf50;
  border: none;
  color: white;
  padding: 6px 12px;
  border-radius: 6px;
  cursor: pointer;
  font-weight: bold;
  margin: 10px 0;
}
.historyItem {
  background: rgba(255,255,255,0.08);
  margin: 10px 0;
  padding: 10px;
  border-radius: 6px;
}
.deleteHistoryBtn {
  background: #ff4444;
  border: none;
  padding: 4px 8px;
  border-radius: 6px;
  cursor: pointer;
  font-weight: bold;
  color: white;
  font-size: 12px;
  margin-top: 5px;
}
#enableSirenBtn {
  position: sticky;
  top: 0;
  left: 0;
  z-index: 1000; /* Make sure it‚Äôs above other elements */
  padding: 6px 12px;
  font-weight: bold;
  cursor: pointer;
  border-radius: 6px;
  background: #ff9800;
  border: none;
}

header button#enableSirenBtn {
  right: 140px; /* Adjust as needed */
  top: 20px;
  background: #ff9800;
}


</style>
</head>
<body>

<header>
üö® Police SOS Control Center üö®
<button onclick="openHistory()">üìú History</button>
<button id="enableSirenBtn">Start Alerts üîî</button>
</header>

<div class="dashboard">
  <div class="leftPanel">
    <canvas id="statusChart" height="200"></canvas>
    <div id="sosContainer">
      <button id="enableSirenBtn">Start Alerts üîî</button>
      <h2>üìã Active SOS Alerts</h2>
      <div>Loading SOS alerts...</div>
    </div>
  </div>
  <div id="map"></div>
</div>

<audio id="siren" src="https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg" preload="auto"></audio>

<div id="historyModal">
  <div id="historyContent">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <h2>üìú SOS History Logs</h2>
      <button class="closeBtn" onclick="closeHistory()">‚úñ Close</button>
    </div>
    <button class="downloadBtn" onclick="downloadHistory()">‚¨á Download CSV</button>
    <div id="historyList">No history available.</div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
// ================== SOS MANAGEMENT ==================
function generateSOSId() {
    let lastId = parseInt(localStorage.getItem("lastSOSId") || "0");
    lastId++;
    localStorage.setItem("lastSOSId", lastId);
    return lastId;
}

function createSOS(lat, lng) {
    if (typeof lat !== "number" || typeof lng !== "number") {
        console.error("Invalid coordinates for SOS!");
        return;
    }
    let sosLogs = getSOS();
    const newSOS = {
        id: generateSOSId(), // always generate ID
        lat: lat,
        lng: lng,
        timestamp: new Date().toISOString(),
        status: "Pending"
    };
    sosLogs.push(newSOS);
    saveSOS(sosLogs);
    lastSOSCount = sosLogs.length; // update last count for siren
    window.dispatchEvent(new Event('storage'));
}


// ================== LOCAL STORAGE HELPERS ==================
function getSOS(){ return JSON.parse(localStorage.getItem("sosLogs") || "[]"); }
function saveSOS(data){ localStorage.setItem("sosLogs", JSON.stringify(data)); }
function getHistory(){ return JSON.parse(localStorage.getItem("sosHistory") || "[]"); }
function saveHistory(data){ localStorage.setItem("sosHistory", JSON.stringify(data)); }
function addToHistory(log, action){
    let history=getHistory();
    history.push({id:log.id,...log, action, actionTime:new Date().toLocaleString()});
    saveHistory(history);
}

// ================== HISTORY FUNCTIONS ==================
function openHistory(){ document.getElementById("historyModal").style.display="flex"; loadHistory(); }
function closeHistory(){ document.getElementById("historyModal").style.display="none"; }

function loadHistory(){
    const historyList = document.getElementById("historyList");
    let history = getHistory();
    if(history.length===0){ historyList.innerHTML="<p>No history available.</p>"; return; }
    historyList.innerHTML="";
    history.forEach((h,idx)=>{
        const div=document.createElement("div");
        div.className="historyItem";
        div.innerHTML = `
            üÜî ID: <b>${h.id}</b><br>
            üìç (${h.lat.toFixed(5)}, ${h.lng.toFixed(5)})<br>
            üïí Original: ${new Date(h.timestamp).toLocaleString()}<br>
            üîî Action: ${h.action}<br>
            ‚è∞ At: ${h.actionTime}<br>
            <button class="deleteHistoryBtn" onclick="deleteHistory(${idx})">üóë Delete</button>
        `;
        historyList.appendChild(div);
    });
}
function deleteHistory(idx){ let history=getHistory(); history.splice(idx,1); saveHistory(history); loadHistory(); }
function downloadHistory(){
    let history=getHistory(); if(history.length===0){ alert("No history to download."); return; }
    let csv="Latitude,Longitude,Original Time,Action,Action Time\n";
    history.forEach(h=>{ csv+=`${h.lat},${h.lng},${new Date(h.timestamp).toLocaleString()},${h.action},${h.actionTime}\n`; });
    const blob=new Blob([csv],{type:"text/csv"});
    const url=URL.createObjectURL(blob);
    const a=document.createElement("a"); a.href=url; a.download="sos_history.csv"; a.click();
}

// ================== MAP & CHART ==================
const sosContainer = document.getElementById("sosContainer");
const map = L.map('map').setView([20.5937,78.9629],5);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
const siren = document.getElementById("siren");
const enableBtn = document.getElementById("enableSirenBtn");
let markers = [];
let statusChart;
let lastSOSCount = getSOS().length;
let sirenEnabled = false;

// ================== LOAD SOS & UI ==================
function loadSOS() {
    sosContainer.innerHTML = "<h2>üìã Active SOS Alerts</h2>";
    if(!sirenEnabled) sosContainer.prepend(enableBtn);

    markers.forEach(m => map.removeLayer(m));
    markers = [];
    let sosLogs = getSOS();
    sosLogs = sosLogs.map(log => ({
        ...log,
        id: log.id || generateSOSId()
    }));
    saveSOS(sosLogs);
    if(sosLogs.length === 0){
        sosContainer.innerHTML += "<p>No SOS alerts yet.</p>";
        updateChart();
        return;
    }

    // Play siren if new SOS
    if(sirenEnabled && sosLogs.length > lastSOSCount){
        siren.play().catch(()=>console.log("Siren blocked until user interacts"));
    }
    lastSOSCount = sosLogs.length;

    sosLogs.forEach(log=>{
        if(!log.status) log.status="Pending";
        const item=document.createElement("div");
        item.className="sosItem";
        item.innerHTML=`
            <div>
                üÜî ID: <b>${log.id}</b><br>
                üö® <a href="https://maps.google.com/?q=${log.lat},${log.lng}" target="_blank">
                Location: (${log.lat.toFixed(5)}, ${log.lng.toFixed(5)})</a><br>
                ‚è∞ ${new Date(log.timestamp).toLocaleString()}<br>
                üìå Status: <b>${log.status}</b>
            </div>
            <div>
                <button class="statusBtn pending">Pending</button>
                <button class="statusBtn progress">In Progress</button>
                <button class="statusBtn resolved">Resolved</button><br>
                <button class="deleteBtn">Delete</button>
            </div>
        `;

        item.querySelector(".pending").onclick = ()=>{ updateStatus(log.id,"Pending"); };
        item.querySelector(".progress").onclick = ()=>{ updateStatus(log.id,"In Progress"); };
        item.querySelector(".resolved").onclick = ()=>{ updateStatus(log.id,"Resolved"); };
        item.querySelector(".deleteBtn").onclick = ()=>{ deleteSOS(log.id); };

        sosContainer.appendChild(item);

        const marker = L.marker([log.lat, log.lng]).addTo(map)
            .bindPopup(`<b>üö® SOS Alert</b><br>Status: ${log.status}<br>${new Date(log.timestamp).toLocaleString()}`);
        markers.push(marker);
    });

    if(markers.length>0){
        const group=new L.featureGroup(markers);
        map.fitBounds(group.getBounds().pad(0.5));
    }

    updateChart();
}

// ================== STATUS & DELETE ==================
function updateStatus(id,status){
    let sosLogs=getSOS();
    const sos=sosLogs.find(s=>s.id===id);
    if(!sos) return;
    sos.status=status;
    saveSOS(sosLogs);
    addToHistory(sos,`Status set to ${status}`);
    loadSOS();
}
function deleteSOS(id){
    let sosLogs=getSOS();
    const idx=sosLogs.findIndex(s=>s.id===id);
    if(idx===-1) return;
    addToHistory(sosLogs[idx],"Deleted from active");
    sosLogs.splice(idx,1);
    saveSOS(sosLogs);
    loadSOS();
}

// ================== UPDATE CHART ==================
function updateChart(){
    let sosLogs=getSOS();
    let counts={ "Pending":0, "In Progress":0, "Resolved":0 };
    sosLogs.forEach(log=>{ counts[log.status||"Pending"]++; });
    const data={
        labels:["Pending","In Progress","Resolved"],
        datasets:[{ label:"Active SOS Count", data:[counts["Pending"],counts["In Progress"],counts["Resolved"]], backgroundColor:["#d32f2f","#fbc02d","#388e3c"] }]
    };
    if(statusChart){
        statusChart.data.datasets[0].data=data.datasets[0].data;
        statusChart.update();
    } else{
        const ctx=document.getElementById("statusChart").getContext("2d");
        statusChart=new Chart(ctx,{ type:"bar", data:data, options:{ responsive:true, plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true, ticks:{stepSize:1}}} } });
    }
}

// ================== REAL-TIME UPDATES ==================
window.addEventListener('storage', (e)=>{ if(e.key==="sosLogs") loadSOS(); });
setInterval(loadSOS,5000);

// ================== INITIAL LOAD ==================
loadSOS();

// ================== SIREN ENABLE ==================
enableBtn.onclick = () => {
    sirenEnabled = true;
    siren.play().catch(()=>console.log("Siren blocked until user interacts"));
    alert("Alerts enabled. Siren will play for incoming SOS.");
    enableBtn.style.display = "none";
};
</script>
</body>
</html>
